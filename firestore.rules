rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Admin-readable collections (requires authenticated user in admins/ collection)
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Allow admins to read admin-only collections
    match /admins/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /analytics/{docId} {
      allow read: if request.auth != null;
      allow write: if false; // server-only writes
    }

    match /activityFeed/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /accounting/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /dailyDigest/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /pipeline/{pipelineId}/{subCol}/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /messages/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /draftMessages/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /campaigns/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /ledger/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /payments/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /creatorPayouts/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Users collection — authenticated users can read their own doc, admins can read all
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Workspaces — authenticated users can read their own workspaces
    match /workspaces/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Tenants — members can read
    match /tenants/{tenantId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // RAAS packages
    match /raasPackages/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Memberships
    match /memberships/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Chat messages — user can read/write their own
    match /chatMessages/{docId} {
      allow read, write: if request.auth != null;
    }

    // Message events — authenticated users can read their own conversation history
    match /messageEvents/{docId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false; // server-only writes
    }

    // Chat sessions — authenticated users can read/write their own conversation history
    match /chatSessions/{docId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // Catch-all: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
