# Security & Architecture Audit — 2026-02-14

**Auditor:** Claude Sonnet 4.5 (via Claude Code)
**Target:** `functions/functions/index.js`
**Status:** ✅ All issues resolved

---

## Issues Found & Fixed

### ✅ Issue 1: Missing RAAS Validation Function

**Problem:** No input validation before writing to Firestore. Malformed data could corrupt the append-only ledger.

**Impact:** High — data integrity violation

**Fix Applied:**
- Added `validateAgainstRaas(tenantId, type, row)` function (lines 161-184)
- Validates required fields per entity type: `customers`, `inventory`, `service_appointments`, `sales`, `trade_ins`, `workflow_input`
- Returns `{ valid: boolean, reason?: string }`
- Used in both `/workflows` and `exports.importCsv` handlers

---

### ✅ Issue 2: Door 2 Routes Missing

**Problem:** `STATE.md` documents `/chat`, `/workflows`, `/reportStatus` as canonical Frontdoor routes, but they don't exist in the backend.

**Impact:** Medium — functionality gap, 404 errors on production routes

**Fix Applied:**
- **POST /v1/chat:message** (lines 576-609)
  - Appends `chat:message:received` event to `messageEvents` collection
  - Stub AI response (TODO: replace with actual Claude/OpenAI call)
  - Appends `chat:message:responded` event with response
  - Returns `{ ok, response, eventId }`

- **POST /v1/workflows** (lines 611-641)
  - Validates input via `validateAgainstRaas()`
  - Appends `workflow:initiated` event to `workflowEvents` collection
  - Passes `_workflowEventId` to RAAS handler for audit trail
  - Returns RAAS workflow result

- **GET /v1/reportStatus?jobId=...** (lines 643-668)
  - Fetches job status from `reportJobs` collection
  - Enforces tenant isolation (403 if jobId belongs to different tenant)
  - Returns `{ ok, jobId, status, progress, resultUrl, createdAt, completedAt }`

---

### ✅ Issue 3: CSV Import Not Event-Sourced

**Problem:** Existing `/admin/import` only writes metadata — no actual row processing, no RAAS validation, no event appending.

**Impact:** High — violates event-sourcing invariant

**Fix Applied:**
- Created separate `exports.importCsv` function (lines 688-783)
- Creates `importJobs` record with status tracking
- Validates each row via `validateAgainstRaas()`
- Appends `importEvents` for each valid row (type: `${type}:imported`)
- Collects errors for invalid rows
- Updates job status: `completed`, `partial`, or `failed`
- Returns `{ ok, importJobId, successCount, errorCount, errors }`

---

### ✅ Issue 4: Batch Flush Logic Validation

**Problem:** Firestore limit is 500 operations per batch. Code uses 390 as threshold — is this safe?

**Analysis:**
- importJob creation: 1 op
- Row events: up to 389 ops
- Final status update: 1 op
- **Max per batch:** 391 ops (well under 500 limit)

**Verdict:** ✅ Safe — 390 threshold is correct

---

### ✅ Issue 5: `merge: true` Violations on Canonical Ledger Data (**CRITICAL**)

**Problem:** `{ merge: true }` allows partial updates, violating append-only event-sourcing invariant. Found in 4 locations:

1. **Stripe webhook → `identityVerifications`** (line 220)
2. **Stripe webhook → `users`** (line 236)
3. **Identity session create → `identityVerifications`** (line 378)
4. **File finalize → `files`** (line 516)

**Impact:** Critical — data integrity violation, silent state corruption possible

**Fix Applied:**

**Location 1 & 2 (Stripe webhook):**
- Check if doc exists first
- If new: `set()` with all fields (no merge)
- If existing: `update()` with explicit fields only
- Note: `users` collection merge is OK — it's not an append-only ledger

**Location 3 (Identity session create):**
- Removed `{ merge: true }` entirely
- Changed to `set()` without merge (create-only operation)

**Location 4 (File finalize):**
- Replaced `set({ ...fields }, { merge: true })` with `update({ ...fields })`
- Explicit field update only

**Location 5 (Membership update in onboarding:claimTenant):**
- Replaced `set({ status, updatedAt }, { merge: true })` with `update({ status, updatedAt })`

---

## Testing Recommendations

1. **RAAS Validation:**
   - Send malformed row to `POST /importCsv` → expect 422 validation error
   - Send valid row → expect success

2. **Door 2 Routes:**
   - `POST /chat:message` with `{ message: "test" }` → expect stub response
   - `POST /workflows` with `{ workflowId: "test", input: {} }` → expect RAAS handler call
   - `GET /reportStatus?jobId=nonexistent` → expect 404

3. **Batch Flushing:**
   - Import 1000+ rows via `POST /importCsv` → verify no batch size errors
   - Check Firestore `importEvents` count matches successCount

4. **Event Sourcing:**
   - Verify `identityVerifications` docs are created once, then updated (not merged)
   - Verify `files` finalization uses `update()`, not `set()`

---

## Deployment Checklist

- [x] All fixes applied to `functions/functions/index.js`
- [ ] Run `firebase deploy --only functions` to production
- [ ] Test `/chat:message`, `/workflows`, `/reportStatus` via Frontdoor
- [ ] Verify Firestore security rules allow new collections: `messageEvents`, `workflowEvents`, `reportJobs`, `importJobs`, `importEvents`
- [ ] Update STATE.md if route behavior changed
- [ ] Notify team: Door 2 routes are now live

---

## Files Modified

- `functions/functions/index.js` — 783 lines (was 562 lines)
  - Added `validateAgainstRaas()` function
  - Added 3 Door 2 routes
  - Fixed 5 `merge: true` violations
  - Added `exports.importCsv` function
  - Updated API_VERSION to `2026-02-14-audit-fixes-complete`

---

**Next Steps:**
1. Deploy to Firebase
2. Replace `/chat:message` AI stub with actual Claude/OpenAI integration
3. Add Firestore indexes for new collections if needed
4. Update OpenAPI spec (when created) to document new routes
