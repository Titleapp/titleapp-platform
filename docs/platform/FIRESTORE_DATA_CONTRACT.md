# TitleApp Firestore Data Contract
Version: v1.0  
Owner: CEO (Sean)  
Applies to: title-app-alpha (and all future environments unless overridden)  
Last Updated: 2026-01-21  

## 0) Rule of Engagement (Non-Negotiable)

- **Humans do not hand-edit Firestore data** in the console (except in explicitly documented break-glass procedures).
- Firestore is a **system-of-record**, written by **Firebase Functions only**.
- If we need new fields/collections: we **change code + deploy**, not UI.

---

## 1) Canonical Collections (Current)

### `/system`
**Purpose:** Environment + runtime status, boot events, feature flags, versions.

**Document types (recommended):**
- `/system/{envId}` e.g. `default`, `public`, or a generated boot id
- `/system/config` (optional if we add flags later)

**Required fields (typical):**
- `createdAt` (timestamp)
- `source` (string) e.g. `"api/bootstrap"`
- `status` (string) e.g. `"alive"`
- `version` (string) e.g. `"v1"`

**Notes:**
- Use this for **health checks**, not business data.

---

### `/chatSessions`
**Purpose:** Stateless chat becomes stateful. Stores session context + minimal memory for routing.

**Doc ID:** `{sessionId}` (string provided by client)

**Required fields:**
- `createdAt` (timestamp)
- `updatedAt` (timestamp)
- `tenantId` (string) default `"public"`
- `vertical` (string) e.g. `"real-estate"`, `"auto"`
- `jurisdiction` (string|null) e.g. `"IL"`, `"CA"`
- `state` (object) lightweight conversation state (never large blobs)

**Optional fields:**
- `lastUserMessage` (string) (safe subset)
- `lastAssistantReply` (string) (safe subset)
- `inquiryId` (string|null)
- `jobId` (string|null)

**Forbidden:**
- Full PII dumps, ID images, payment details.

---

### `/inquiries`
**Purpose:** A user’s “case file” for a specific property/VIN/etc. This is the anchor for reports/jobs.

**Doc ID:** `{inquiryId}` generated by backend.

**Required fields:**
- `createdAt` (timestamp)
- `updatedAt` (timestamp)
- `tenantId` (string)
- `vertical` (string)
- `jurisdiction` (string|null)
- `status` (string) e.g. `open | in_progress | closed`
- `inputs` (object) normalized intake data

**Real Estate `inputs` (example):**
- `address.formatted` (string)
- `address.components` (object, optional)
- `apn` (string|null)

**Auto `inputs` (example):**
- `vin` (string)
- `plate` (string|null)

**Optional fields:**
- `requestedBy` (object with safe identifiers only)
- `summary` (string) brief system-generated

---

### `/reportJobs`
**Purpose:** Tracks long-running report generation (queue + status + result pointers).

**Doc ID:** `{jobId}` generated by backend.

**Required fields:**
- `createdAt` (timestamp)
- `updatedAt` (timestamp)
- `tenantId` (string)
- `vertical` (string)
- `jurisdiction` (string|null)
- `inquiryId` (string)
- `reportType` (string) e.g. `preliminary | full | disclosure_packet`
- `status` (string) e.g. `queued | running | complete | failed`
- `progress` (number 0–100, optional but preferred)

**Result fields (when complete):**
- `result` (object)
  - `artifacts` (array) e.g. pdf urls, doc refs
  - `summary` (string)
- `error` (object|null)
  - `message` (string)
  - `code` (string)

---

### `/autoJobs`
**Purpose:** Tracks long-running auto workflows (RO creation, finance packet, etc.)

**Doc ID:** `{jobId}` generated by backend.

**Required fields:** same shape as `/reportJobs`, but `jobType` replaces `reportType`.

**Example `jobType`:**
- `service_appt_to_ro`
- `used_sale_cash_or_finance`
- `trade_in_intake`
- `fleet_service_intake`

---

### `/requests`
**Purpose:** Optional generic wrapper for “request objects” if we unify jobs across verticals.
**Status:** Present but may be transitional.

**Rule:**
- If we keep `/requests`, it must point to exactly one of:
  - an inquiry
  - a job
  - both

**Recommended required fields:**
- `createdAt`, `updatedAt`, `tenantId`, `vertical`, `jurisdiction`
- `sessionId` (string)
- `inquiryId` (string|null)
- `jobId` (string|null)
- `intent` (string) e.g. `create_inquiry | run_workflow | start_report`

---

## 2) Status & State Machine (Canonical)

### Inquiry status
- `open` → `in_progress` → `closed`

### Job status
- `queued` → `running` → (`complete` | `failed`)

---

## 3) Data Safety Rules

- Never store credit card data.
- Never store SSN.
- Never store raw ID document images in Firestore.
- Store only the **minimum** needed to complete workflows.
- Prefer storing references (URLs / storage paths) rather than large blobs.

---

## 4) Indexing Guidance (Only when needed)

Add indexes only when we introduce queries like:
- `where tenantId == X and status == queued orderBy createdAt`
- `where inquiryId == X orderBy createdAt`

No speculative indexes.

---

## 5) Compatibility

Any new collection/field must:
1) Be added to Functions code
2) Be documented here
3) Be deployed
4) Be tested via curl

End.
