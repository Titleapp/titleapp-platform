<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TitleApp – Data Import</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #f5f7fa;
      padding: 40px;
    }
    .drop {
      border: 2px dashed #999;
      border-radius: 12px;
      padding: 60px;
      text-align: center;
      background: white;
      cursor: pointer;
    }
    .drop.dragover {
      border-color: #2563eb;
      background: #eef2ff;
    }
    button {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 16px;
    }
    pre {
      margin-top: 20px;
      background: #111;
      color: #0f0;
      padding: 16px;
      max-height: 300px;
      overflow: auto;
    }
    .hint {
      margin-top: 10px;
      color: #4b5563;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h1>Upload Data File</h1>

<div id="drop" class="drop">
  Drag & drop file here<br><br>
  or click to select
</div>

<div class="hint">
  Allowed: <b>.csv</b>, <b>.txt</b>, <b>.json</b> (text-only)
</div>

<button id="upload" disabled>Upload</button>

<pre id="out"></pre>

<script>
let rawText = "";
let fileName = "";
let detectedType = "";

const ALLOWED = [".csv", ".txt", ".json"];

const drop = document.getElementById("drop");
const upload = document.getElementById("upload");
const out = document.getElementById("out");

function extOf(name) {
  const i = name.lastIndexOf(".");
  return i === -1 ? "" : name.slice(i).toLowerCase();
}

function detectTypeFromExt(ext) {
  if (ext === ".csv") return "csv";
  if (ext === ".txt") return "txt";
  if (ext === ".json") return "json";
  return "unknown";
}

drop.onclick = () => {
  const i = document.createElement("input");
  i.type = "file";
  i.accept = ALLOWED.join(",");
  i.onchange = e => handleFile(e.target.files[0]);
  i.click();
};

drop.ondragover = e => {
  e.preventDefault();
  drop.classList.add("dragover");
};

drop.ondragleave = () => drop.classList.remove("dragover");

drop.ondrop = e => {
  e.preventDefault();
  drop.classList.remove("dragover");
  handleFile(e.dataTransfer.files[0]);
};

function handleFile(file) {
  if (!file || !file.name) {
    alert("No file selected");
    return;
  }

  const ext = extOf(file.name);
  if (!ALLOWED.includes(ext)) {
    alert("Text files only: .csv, .txt, .json");
    return;
  }

  fileName = file.name;
  detectedType = detectTypeFromExt(ext);

  const r = new FileReader();
  r.onload = () => {
    rawText = r.result || "";
    upload.disabled = rawText.length === 0;
    out.textContent =
      `Loaded ${fileName}\n` +
      `Type: ${detectedType}\n\n` +
      `${rawText.slice(0,500)}${rawText.length > 500 ? "…" : ""}`;
  };
  r.readAsText(file);
}

upload.onclick = async () => {
  upload.disabled = true;
  out.textContent = "Uploading…";

  const token = localStorage.getItem("ID_TOKEN") || "";

  const res = await fetch("/v1/admin/import", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token,
      "x-tenant-id": "demo"
    },
    body: JSON.stringify({
      tenantId: "demo",
      // keep legacy fields (safe to ignore later)
      mode: "upsert",
      source: { type: "upload", label: fileName },
      // IMPORTANT: backend currently reads csvText; we reuse it as "raw text"
      csvText: rawText,
      // new, more accurate type for future routing
      type: detectedType
    })
  });

  out.textContent = JSON.stringify(await res.json(), null, 2);
};
</script>

</body>
</html>
